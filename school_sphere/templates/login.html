<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Доступ к API</title>
</head>
<body>
    <h1>Вход для доступа к API</h1>
    <form id="login-form">
        <label for="username">Логин:</label>
        <input type="text" id="username" name="username" required><br>

        <label for="password">Пароль:</label>
        <input type="password" id="password" name="password" required><br>

        <button type="submit">Войти</button>
    </form>

    <div id="error-message" style="color: red; display: none;"></div>

    <div id="api-content" style="display: none;">
        <h2>Доступные API</h2>
        <ul id="api-list"></ul>
    </div>

   <script>
    document.addEventListener('DOMContentLoaded', async function () {
        const accessToken = localStorage.getItem('access_token');
        if (accessToken) {
            await loadApiContent(accessToken);
        }
    });

    document.getElementById('login-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const errorMessage = document.getElementById('error-message');
        errorMessage.style.display = 'none';

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {

            const tokenResponse = await fetch('/api/auth/token/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            });

            if (!tokenResponse.ok) {
                throw new Error('Ошибка авторизации. Проверьте логин и пароль.');
            }

            const tokenData = await tokenResponse.json();


            localStorage.setItem('access_token', tokenData.access);
            localStorage.setItem('refresh_token', tokenData.refresh);

            document.getElementById('login-form').style.display = 'none';
            await loadApiContent(tokenData.access);
        } catch (error) {
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
        }
    });

    async function loadApiContent(accessToken) {
        try {
            const response = await fetch('/api/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                },
            });

            if (!response.ok) {
                throw new Error(`Ошибка загрузки API. Статус: ${response.status}`);
            }

            const apiData = await response.json();

            if (Object.keys(apiData).length === 0) {
                throw new Error('Нет доступных API.');
            }

            const apiList = document.getElementById('api-list');
            apiList.innerHTML = '';

            for (const [key, url] of Object.entries(apiData)) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = url;
                link.textContent = key;
                link.target = '_blank';
                listItem.appendChild(link);
                apiList.appendChild(listItem);
            }

            document.getElementById('api-content').style.display = 'block';
        } catch (error) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
        }
    }
    </script>
</body>
</html>
